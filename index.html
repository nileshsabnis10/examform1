<!DOCTYPE html>
<html>
<head>
    <link rel="icon" href="https://lh3.googleusercontent.com/d/1aJbfe9GQva6XOX5vy8Mn_yveR9EmPP_x">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winter 25 - Backlog Exam Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinner for loading state */
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #fff;
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* --- 3D Effect & Darker Shade --- */
        .input-3d {
            background-color: #f3f4f6; /* bg-gray-100 */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .input-3d:focus {
            background-color: #fff;
            box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    
    <div class="max-w-3xl w-full space-y-8">
    
        <div class="bg-white p-8 sm:p-10 shadow-2xl rounded-2xl border border-gray-300">
            <header class="text-center mb-8">
                
                <img src="https://lh3.googleusercontent.com/d/1IUqbqFGzjB5zC9O8ZlVZczNBCLKyJ0u6" alt="Form Header" class="mx-auto w-full max-w-lg rounded-md shadow-md">
                
                <p class="mt-4 text-2xl font-semibold text-gray-800">
                    Winter 2025 Backlog Exam Form
                </p>
            </header>

            <div id="successMessage" class="hidden p-4 mb-6 rounded-md bg-green-100 border border-green-300">
                <p class="text-sm font-medium text-green-800" id="successText">
                    Form submitted successfully! Your response has been recorded.
                </p>
            </div>

            <div id="errorMessage" class="hidden p-4 mb-6 rounded-md bg-red-100 border border-red-300">
                <p class="text-sm font-medium text-red-800" id="errorText">
                    An error occurred. Please try submitting the form again.
                </p>
            </div>

            <form id="examForm">
                <div class="space-y-6">

                    <fieldset class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" name="Name" id="fullName" required class="input-3d mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                            <p class="mt-1 text-xs text-gray-500">Enter full name as: First Name, Middle Name, Surname.</p>
                        </div>
                        <div>
                            <label for="prnNumber" class="block text-sm font-medium text-gray-700">PRN</label>
                            <input type="text" name="PRNNo" id="prnNumber" required class="input-3d mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email ID</label>
                            <input type="email" name="EmailID" id="email" required class="input-3d mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                            <p class="mt-1 text-xs text-red-500"><strong>PDF will be mailed to this address.</strong></p>
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700">Mobile No</label>
                            <input type="tel" name="MobileNo" id="phone" required class="input-3d mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                        </div>
                    </fieldset>

                   <fieldset class="space-y-6">
                        <div>
                            <label for="branch" class="block text-sm font-medium text-gray-700">Branch</label>
                            <select id="branch" name="Branch" required class="input-3d mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                                <option value="" disabled selected>Select your branch</option>
                                </select>
                        </div>


                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="semester" class="block text-sm font-medium text-gray-700">Semester</label>
                                <select id="semester" name="Semester" required class="input-3d mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3">
                                    <option value="" disabled selected>Select branch first</option>
                                    </select>
                                <p class="mt-1 text-xs text-gray-500">Select each semester one by one for which you have backlog courses.</p><br>
                            </div>
                            <div>
                                <label for="totalCourses" class="block text-sm font-medium text-gray-700">Total Courses</label>
                                <input type="number" name="TotalCourses" id="totalCourses" class="input-3d mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3" disabled>
                                <p class="text-xs text-gray-500 mt-1">This field is updated by the summary.</p>
                            </div>
                        </div>
                    </fieldset>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Courses for Examination</label>
                        <p class="text-sm text-gray-500">Select a branch and semester to see courses.<br>You can switch semesters and your selections will be saved.</p>
                        <div id="coursesContainer" class="mt-2 space-y-4 p-4 border border-gray-200 rounded-md bg-red-50 min-h-[150px]">
                            <p id="coursesPlaceholder" class="text-sm text-gray-500">Please select your branch and semester first.</p>
                            </div>
                    </div>
                    
                    <div id="summarySection">
                        <label class="block text-sm font-medium text-gray-700">Selected Courses Summary<br><label class="block text-sm font-medium text-red-700"><strong>Please verify that all your Backlog Courses are listed below before submitting the form.</strong></label>
                        <div id="summaryContainer" class="mt-2 space-y-2 p-4 border border-blue-200 rounded-md bg-blue-50 min-h-[100px]">
                            <p class="text-sm text-gray-500">No courses selected yet.</p>
                        </div>
                    </div>

                    <div id="feesSection">
                        <label class="block text-sm font-medium text-gray-700">Total Fees</label>
                        <div id="feesContainer" class="mt-2 p-4 border border-green-300 rounded-md bg-green-50">
                            <p id="feesDisplay" class="text-lg font-semibold text-green-800">₹ 0.00</p>
                            <p class="text-xs text-gray-500">Based on ₹ 300.00 per course.</p>
                        </div>
                        <input type="hidden" name="Fees" id="hiddenFees" value="₹ 0.00">
                    </div>

                    <fieldset class="space-y-2">
                        <div class="relative flex items-start">
                            <div class="flex h-5 items-center">
                                <input id="declarationCheckbox" name="declaration" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="declarationCheckbox" class="font-medium text-gray-700"><strong>I declare that I have selected all courses applicable for all semesters. I will be responsible for any mistakes.</strong></label>
                            </div>
                        </div>
                    </fieldset>
                    
                    <fieldset class="space-y-2">
                        <div class="relative flex items-start">
                            <div class="flex h-5 items-center">
                                <input id="declarationCheckbox2" name="declaration2" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="declarationCheckbox2" class="font-medium text-gray-700"><strong>I understand that this submission is final and cannot be modified.</strong></label>
                            </div>
                        </div>
                    </fieldset>

                    <div>
                        <button type="submit" id="submitButton" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            <span id="buttonText">Submit Application</span>
                            <div id="buttonSpinner" class="hidden spinner"></div>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <div class="bg-white p-6 sm:p-8 shadow-xl rounded-2xl border border-gray-200">
            <h3 class="text-lg font-medium leading-6 text-gray-900">Download Submitted Form (PDF)</h3>
            <p class="mt-1 text-sm text-gray-600">If you have already submitted the form, you can download your PDF here using your PRN after <strong>one hour</strong> of form submission.</p>
            
            <form id="pdfDownloadForm" class="mt-4">
                <div class="flex flex-col sm:flex-row gap-4 items-start">
                    <div class="flex-grow w-full">
                        <label for="pdfPrnNumber" class="sr-only">PRN Number</label>
                        <input type="text" name="pdfPrnNumber" id="pdfPrnNumber" class="input-3d block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm h-10 px-3" placeholder="Enter your PRN Number" required>
                    </div>
                    <button type="submit" id="downloadPdfButton" class="w-full sm:w-auto flex-shrink-0 flex justify-center py-2 px-6 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200 disabled:bg-gray-400">
                        <span id="pdfButtonText">Get PDF</span>
                        <div id="pdfButtonSpinner" class="hidden spinner"></div>
                    </button>
                </div>
            </form>
            
            <div id="pdfMessageContainer" class="mt-3 min-h-[1.25rem]"> <p id="pdfErrorText" class="hidden text-sm font-medium text-red-700"></p>
            </div>
        </div>
        </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURATION ---

        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // !!! CRITICAL: YOU MUST UPDATE THIS URL AFTER YOU DEPLOY !!!
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        //
        //  FIX 3: This URL is a placeholder. You MUST replace it
        //  with your own new deployment URL.
        //
        const formScriptURL = 'https://script.google.com/macros/s/AKfycbzGNurJ5Wjmdxqt9UbXMaFyV__q1tOR_nNXmTwIaQzFpuurbvs55agLrqU72rIHqRTx8Q/exec';

        // --- COURSE DATA ---
        let coursesByBranchAndSem = {};

        // --- ELEMENT REFERENCES ---
        const form = document.getElementById('examForm');
        const branchSelect = document.getElementById('branch');
        const semesterSelect = document.getElementById('semester');
        const coursesContainer = document.getElementById('coursesContainer');
        const coursesPlaceholder = document.getElementById('coursesPlaceholder');
        const summaryContainer = document.getElementById('summaryContainer'); 
        const totalCoursesInput = document.getElementById('totalCourses');
        const feesDisplay = document.getElementById('feesDisplay'); 
        const hiddenFeesInput = document.getElementById('hiddenFees'); 
        const errorText = document.getElementById('errorText'); 
        const successText = document.getElementById('successText'); 
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const buttonSpinner = document.getElementById('buttonSpinner');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const declarationCheckbox1 = document.getElementById('declarationCheckbox'); 
        const declarationCheckbox2 = document.getElementById('declarationCheckbox2');

        // --- *** NEW: PDF DOWNLOAD REFERENCES *** ---
        const pdfDownloadForm = document.getElementById('pdfDownloadForm');
        const pdfPrnInput = document.getElementById('pdfPrnNumber');
        const pdfDownloadButton = document.getElementById('downloadPdfButton');
        const pdfButtonText = document.getElementById('pdfButtonText');
        const pdfButtonSpinner = document.getElementById('pdfButtonSpinner');
        const pdfErrorText = document.getElementById('pdfErrorText');


        // --- FUNCTIONS ---

        function checkDeclaration() {
            submitButton.disabled = !(declarationCheckbox1.checked && declarationCheckbox2.checked);
        }

        function populateCourses() {
            const selectedBranch = branchSelect.value;
            const selectedSemester = semesterSelect.value;

            const cleanBranch = selectedBranch.replace(/[^a-zA-Z0-9]/g, '-');
            const cleanSemester = selectedSemester.replace(/[^a-zA-Z0-T]/g, '-'); // Typo fixed from T to 9
            const containerId = `courses-${cleanBranch}-${cleanSemester}`;

            if (coursesPlaceholder) {
                coursesPlaceholder.classList.add('hidden');
            }

            coursesContainer.querySelectorAll('div[data-group="courses"]').forEach(div => {
                div.classList.add('hidden');
            });

            if (!selectedBranch || !selectedSemester) {
                if(coursesPlaceholder) {
                    coursesPlaceholder.textContent = selectedBranch ? "Please select a semester." : "Please select your branch and semester first.";
                    coursesPlaceholder.classList.remove('hidden');
                }
                coursesContainer.querySelectorAll('div[data-group="courses"]').forEach(div => {
                    div.classList.add('hidden');
                });
                return; 
            }

            let courseGroup = document.getElementById(containerId);

            if (!courseGroup) {
                const courses = (coursesByBranchAndSem[selectedBranch] && coursesByBranchAndSem[selectedBranch][selectedSemester]) ? coursesByBranchAndSem[selectedBranch][selectedSemester] : undefined;

                courseGroup = document.createElement('div');
                courseGroup.id = containerId;
                courseGroup.setAttribute('data-group', 'courses');
                courseGroup.setAttribute('data-semester', selectedSemester);

                if (courses && courses.length > 0) {
                    const header = document.createElement('p');
                    header.className = 'text-sm font-semibold text-gray-700';
                    header.textContent = `Courses for Semester: ${selectedSemester}`;
                    courseGroup.appendChild(header);

                    const innerList = document.createElement('div');
                    innerList.className = 'space-y-2 mt-2 pl-4';
                    courseGroup.appendChild(innerList);

                    courses.forEach(course => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center';

                        const input = document.createElement('input');
                        input.type = 'checkbox';
                        input.name = 'Courses';
                        input.value = `${selectedSemester} - ${course.code} - ${course.name.replace(/\n/g, ' ')}`;
                        input.id = `course-${course.code}-${cleanSemester}`;
                        input.className = 'h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500';

                        const label = document.createElement('label');
                        label.htmlFor = input.id;
                        const displayName = course.name.replace(/\n/g, '<br>');
                        label.innerHTML = `${displayName} <span class="ml-2 text-sm text-gray-500 font-mono">(${course.code})</span>`;
                        label.className = 'ml-3 block text-sm text-gray-700';

                        div.appendChild(input);
                        div.appendChild(label);
                        innerList.appendChild(div);
                    });
                } else {
                    courseGroup.innerHTML = `<p class="text-sm text-gray-500">No courses defined for Branch: ${branchSelect.options[branchSelect.selectedIndex].text}, Semester: ${selectedSemester}.</p>`;
                }
                coursesContainer.appendChild(courseGroup);

            } else {
                courseGroup.classList.remove('hidden');
            }
        }

        function updateSummary() {
            const allCheckedBoxes = coursesContainer.querySelectorAll('input[type="checkbox"]:checked');
            const totalCourses = allCheckedBoxes.length;

            const feesPerCourse = 300;
            const totalFees = totalCourses * feesPerCourse;

            const formattedFees = new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(totalFees).replace('₹', '₹ ');

            totalCoursesInput.value = totalCourses;
            feesDisplay.textContent = formattedFees;
            hiddenFeesInput.value = formattedFees;

            summaryContainer.innerHTML = '';

            if (allCheckedBoxes.length === 0) {
                summaryContainer.innerHTML = '<p class="text-sm text-gray-500">No courses selected yet.</p>';
            } else {
                const list = document.createElement('ul');
                list.className = 'list-disc list-inside space-y-1';

                allCheckedBoxes.forEach(checkbox => {
                    const item = document.createElement('li');
                    item.className = 'text-sm text-gray-800';
                    item.textContent = checkbox.value.replace(/\n/g, ' ');
                    list.appendChild(item);
                });
                summaryContainer.appendChild(list);
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault(); 

            const confirmed = confirm("Are you sure you want to submit the form?\n\nPlease double-check your selected Semesters, Courses and Personal Details.\n\nAfter Submission you can not edit it and this is only one time submission");
            if (!confirmed) {
                return; 
            }

            if (formScriptURL === 'YOUR_NEW_DEPLOYMENT_URL_GOES_HERE') {
                 showError('Form is not configured. Please follow the deployment steps.');
                 return;
            }

            setLoading(true);
            hideMessages();

            try {
                const formData = new FormData(form);

                formData.set('TotalCourses', totalCoursesInput.value);
                formData.delete('Semester');
                formData.set('Fees', hiddenFeesInput.value);

                const response = await fetch(formScriptURL, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'success') {
                        showSuccess(result.message); 
                        form.reset(); 
                        coursesContainer.innerHTML = ''; 
                        if(coursesPlaceholder) {
                            coursesPlaceholder.textContent = "Please select your branch and semester first.";
                            coursesPlaceholder.classList.remove('hidden');
                        }
                        updateSummary(); 
                        resetSemesterDropdown();
                        checkDeclaration(); 
                    } else {
                        throw new Error(result.message || 'Submission failed.');
                    }
                } else {
                    throw new Error(`Network response was not ok. Status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                showError(`Submission failed. ${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        // --- *** NEW: PDF DOWNLOAD FUNCTIONS *** ---

        async function handleGetPdfSubmit(e) {
            e.preventDefault();
            const prn = pdfPrnInput.value.trim();
            if (!prn) {
                showPdfError("Please enter your PRN Number.");
                return;
            }

            setPdfLoading(true);
            
            try {
                // Use the same formScriptURL, but add query parameters
                const url = new URL(formScriptURL);
                url.searchParams.append('action', 'getPdf');
                url.searchParams.append('prn', prn);

                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Network error. Status: ${response.status}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    showPdfError(""); // Clear any previous error
                    // Open the PDF link in a new tab
                    window.open(result.link, '_blank');
                    pdfPrnInput.value = ''; // Clear input on success
                } else {
                    // Show the error message from the server
                    showPdfError(result.message || 'An unknown error occurred.');
                }

            } catch (error) {
                console.error('Error fetching PDF:', error);
                showPdfError(`An error occurred: ${error.message}`);
            } finally {
                setPdfLoading(false);
            }
        }

        function setPdfLoading(isLoading) {
            if (isLoading) {
                pdfDownloadButton.disabled = true;
                pdfButtonText.classList.add('hidden');
                pdfButtonSpinner.classList.remove('hidden');
                pdfErrorText.classList.add('hidden');
                pdfErrorText.textContent = '';
            } else {
                pdfDownloadButton.disabled = false;
                pdfButtonText.classList.remove('hidden');
                pdfButtonSpinner.classList.add('hidden');
            }
        }

        function showPdfError(message) {
            if (message) {
                pdfErrorText.textContent = message;
                pdfErrorText.classList.remove('hidden');
            } else {
                pdfErrorText.textContent = '';
                pdfErrorText.classList.add('hidden');
            }
        }

        // --- *** END: PDF DOWNLOAD FUNCTIONS *** ---


        function resetSemesterDropdown() {
            while (semesterSelect.options.length > 1) {
                semesterSelect.remove(1);
            }
            semesterSelect.value = '';
            semesterSelect.options[0].textContent = 'Select branch first';
        }

        function setLoading(isLoading) {
            if (isLoading) {
                submitButton.disabled = true;
                buttonText.classList.add('hidden');
                buttonSpinner.classList.remove('hidden');
            } else {
                checkDeclaration();
                buttonText.classList.remove('hidden');
                buttonSpinner.classList.add('hidden');
            }
        }

        function hideMessages() {
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
            errorText.textContent = "An error occurred. Please try submitting the form again.";
        }

        function showSuccess(message) {
            successText.textContent = message;
            successMessage.classList.remove('hidden');
errorMessage.classList.add('hidden');
            window.scrollTo(0, 0); 
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            successMessage.classList.add('hidden');
            window.scrollTo(0, 0);
        }

        async function loadCoursesAndInitialize() {
            branchSelect.disabled = true;
            semesterSelect.disabled = true;
            coursesPlaceholder.textContent = "Loading course data, please wait...";
            coursesPlaceholder.classList.remove('hidden');

            if (formScriptURL === 'YOUR_NEW_DEPLOYMENT_URL_GOES_HERE') {
                showError('Form not configured. Please update the formScriptURL in the HTML file.');
                return;
            }

            try {
                const response = await fetch(formScriptURL + "?action=getCourses");
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                coursesByBranchAndSem = await response.json();

                if (coursesByBranchAndSem.status === 'error') {
                    throw new Error(coursesByBranchAndSem.message);
                }

                // --- *** NEW DYNAMIC BRANCH POPULATION *** ---
                const branches = Object.keys(coursesByBranchAndSem);
                branches.sort(); // Sort them alphabetically
                
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch;
                    option.textContent = branch;
                    branchSelect.appendChild(option);
                });
                // --- *** END OF NEW CODE *** ---

                // Success! Enable the form
                branchSelect.disabled = false;
                semesterSelect.disabled = false;
                coursesPlaceholder.textContent = "Please select your branch and semester first.";

                branchSelect.addEventListener('change', () => {
                    const selectedBranch = branchSelect.value;
                    const semesters = selectedBranch ? Object.keys(coursesByBranchAndSem[selectedBranch] || {}) : [];
                    
                    resetSemesterDropdown();
                    
                    if (semesters.length > 0) {
                        semesterSelect.options[0].textContent = 'Select your semester';
                        semesters.sort((a, b) => {
                            const numA = parseInt(a.match(/\d+/));
                            const numB = parseInt(b.match(/\d+/));
                            if (numA && numB && numA !== numB) {
                                return numA - numB;
                            }
                            return a.localeCompare(b);
                        }).forEach(semester => {
                            const option = document.createElement('option');
                            option.value = semester;
                            option.textContent = semester;
                            semesterSelect.appendChild(option);
                        });
                    }

                    semesterSelect.value = '';
                    populateCourses();
                    updateSummary();
                });
                
                semesterSelect.addEventListener('change', populateCourses);
                
                coursesContainer.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        updateSummary();
                    }
                });
                
                declarationCheckbox1.addEventListener('change', checkDeclaration);
                declarationCheckbox2.addEventListener('change', checkDeclaration);
                
                form.addEventListener('submit', handleFormSubmit);

                // --- *** NEW: ADD PDF FORM LISTENER *** ---
                pdfDownloadForm.addEventListener('submit', handleGetPdfSubmit);

                updateSummary();

            } catch (error) {
                console.error('Failed to load course data:', error);
                showError(`Critical Error: Could not load course data. Please refresh the page. (${error.message})`);
                coursesPlaceholder.textContent = "Error loading courses. Please refresh.";
            }
        }

        // --- INITIALIZATION ---
        loadCoursesAndInitialize();
    });
    </script>
</body>

</html>